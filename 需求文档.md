# VPN销售网站系统需求文档

## 1. 项目概述

### 1.1 项目名称
VPN销售管理系统 (CloudFlare XPanel)

### 1.2 项目目标
构建一个基于Cloudflare Pages + D1数据库的VPN销售网站，支持多种套餐销售、用户管理、推广分销、兑换码系统等功能。

### 1.3 技术栈
- **前端**: React + TypeScript + Tailwind CSS
- **后端**: Cloudflare Workers + Hono.js
- **数据库**: Cloudflare D1 (SQLite)
- **部署**: Cloudflare Pages
- **支付**: 支付宝/微信/PayPal集成
- **认证**: JWT Token

## 2. 功能需求

### 2.1 用户前台功能

#### 2.1.1 首页展示
- [ ] 产品介绍和特色展示
- [ ] 套餐价格表展示
- [ ] 节点速度测试
- [ ] 用户评价展示
- [ ] 在线客服支持

#### 2.1.2 套餐管理
- [ ] **包月套餐**: 30天有效期
- [ ] **包季套餐**: 90天有效期  
- [ ] **半年套餐**: 180天有效期
- [ ] **包年套餐**: 365天有效期
- [ ] **自定义套餐**: 管理员可设置任意天数
- [ ] 套餐特色说明（流量、设备数、节点等）
- [ ] 套餐对比功能

#### 2.1.3 用户系统
- [ ] 用户注册（邮箱/手机号）
- [ ] 用户登录/登出
- [ ] 忘记密码重置
- [ ] 邮箱验证
- [ ] 第三方登录（可选）

#### 2.1.4 购买流程
- [ ] 套餐选择
- [ ] 订单确认
- [ ] 支付处理
- [ ] 订单状态跟踪
- [ ] 购买成功通知

#### 2.1.5 兑换码系统
- [ ] **免注册兑换**: 输入兑换码直接获取服务
- [ ] 兑换码验证
- [ ] 兑换历史记录
- [ ] 兑换码状态显示

### 2.2 用户中心功能

#### 2.2.1 账户信息
- [ ] 个人资料管理
- [ ] 密码修改
- [ ] 邮箱绑定/修改
- [ ] 账户安全设置

#### 2.2.2 订阅管理
- [ ] 当前订阅状态
- [ ] 订阅到期时间
- [ ] 流量使用情况
- [ ] 续费提醒
- [ ] 订阅历史记录

#### 2.2.3 节点信息
- [ ] 可用节点列表
- [ ] 节点延迟显示
- [ ] 节点负载状态
- [ ] 连接配置下载
- [ ] 使用教程

#### 2.2.4 推广中心
- [ ] 推广链接生成
- [ ] 推广二维码
- [ ] 推广统计数据
- [ ] 佣金收益查看
- [ ] 下级用户管理
- [ ] 佣金提现申请

#### 2.2.5 财务中心
- [ ] 充值记录
- [ ] 消费记录
- [ ] 佣金记录
- [ ] 提现记录
- [ ] 发票管理

### 2.3 管理员后台功能

#### 2.3.1 仪表板
- [ ] 系统概览统计
- [ ] 收入统计图表
- [ ] 用户增长趋势
- [ ] 节点状态监控
- [ ] 实时在线用户

#### 2.3.2 用户管理
- [ ] 用户列表查看
- [ ] 用户信息编辑
- [ ] 用户状态管理（启用/禁用）
- [ ] 用户订阅管理
- [ ] 用户流量重置
- [ ] 批量操作功能

#### 2.3.3 套餐管理
- [ ] 套餐创建/编辑/删除
- [ ] 套餐价格设置
- [ ] 套餐流量配置
- [ ] 套餐设备数限制
- [ ] 套餐有效期设置
- [ ] 套餐排序管理

#### 2.3.4 节点管理
- [ ] **节点API添加**: 支持多种协议
  - [ ] Shadowsocks节点
  - [ ] V2Ray节点  
  - [ ] Trojan节点
  - [ ] Hysteria节点
- [ ] 节点信息编辑
- [ ] 节点状态监控
- [ ] 节点负载均衡
- [ ] 节点分组管理
- [ ] 节点测速功能

#### 2.3.5 兑换码管理
- [ ] **批量生成兑换码**
- [ ] 兑换码类型设置（套餐绑定）
- [ ] 兑换码有效期设置
- [ ] 兑换码使用统计
- [ ] 兑换码导出功能
- [ ] 兑换码作废功能

#### 2.3.6 推广管理
- [ ] 推广员等级设置
- [ ] 佣金比例配置
- [ ] 推广统计报表
- [ ] 佣金结算管理
- [ ] 推广活动管理
- [ ] 推广素材管理

#### 2.3.7 订单管理
- [ ] 订单列表查看
- [ ] 订单状态管理
- [ ] 退款处理
- [ ] 订单统计分析
- [ ] 异常订单处理

#### 2.3.8 财务管理
- [ ] 收入统计报表
- [ ] 支出记录管理
- [ ] 佣金发放记录
- [ ] 财务对账功能
- [ ] 税务报表生成

#### 2.3.9 系统设置
- [ ] 网站基本信息
- [ ] 支付接口配置
- [ ] 邮件服务配置
- [ ] 安全策略设置
- [ ] 系统日志查看

## 3. 数据库设计

### 3.1 用户相关表

#### users (用户表)
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    username VARCHAR(100),
    phone VARCHAR(20),
    avatar_url VARCHAR(500),
    status TINYINT DEFAULT 1, -- 1:正常 0:禁用
    referrer_id INTEGER, -- 推荐人ID
    referral_code VARCHAR(20) UNIQUE, -- 推广码
    balance DECIMAL(10,2) DEFAULT 0, -- 账户余额
    commission_balance DECIMAL(10,2) DEFAULT 0, -- 佣金余额
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES users(id)
);
```

#### user_subscriptions (用户订阅表)
```sql
CREATE TABLE user_subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    plan_id INTEGER NOT NULL,
    status TINYINT DEFAULT 1, -- 1:有效 0:过期 2:暂停
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    traffic_used BIGINT DEFAULT 0, -- 已用流量(字节)
    traffic_total BIGINT NOT NULL, -- 总流量(字节)
    device_limit INTEGER DEFAULT 3, -- 设备数限制
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (plan_id) REFERENCES plans(id)
);
```

### 3.2 套餐相关表

#### plans (套餐表)
```sql
CREATE TABLE plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    duration_days INTEGER NOT NULL, -- 有效天数
    traffic_gb INTEGER NOT NULL, -- 流量GB
    device_limit INTEGER DEFAULT 3,
    sort_order INTEGER DEFAULT 0,
    is_active TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 节点相关表

#### servers (服务器节点表)
```sql
CREATE TABLE servers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    host VARCHAR(255) NOT NULL,
    port INTEGER NOT NULL,
    protocol VARCHAR(20) NOT NULL, -- ss, v2ray, trojan, hysteria
    method VARCHAR(50), -- 加密方式
    password VARCHAR(255),
    uuid VARCHAR(255),
    path VARCHAR(255),
    country VARCHAR(50),
    city VARCHAR(50),
    load_balance INTEGER DEFAULT 0, -- 负载权重
    is_active TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3.4 兑换码相关表

#### redemption_codes (兑换码表)
```sql
CREATE TABLE redemption_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(50) UNIQUE NOT NULL,
    plan_id INTEGER NOT NULL,
    status TINYINT DEFAULT 0, -- 0:未使用 1:已使用 2:已过期
    used_by INTEGER, -- 使用者ID
    used_at DATETIME,
    expires_at DATETIME,
    created_by INTEGER NOT NULL, -- 创建者ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (plan_id) REFERENCES plans(id),
    FOREIGN KEY (used_by) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);
```

### 3.5 订单相关表

#### orders (订单表)
```sql
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_no VARCHAR(50) UNIQUE NOT NULL,
    user_id INTEGER NOT NULL,
    plan_id INTEGER NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    status TINYINT DEFAULT 0, -- 0:待支付 1:已支付 2:已取消 3:已退款
    payment_method VARCHAR(20), -- alipay, wechat, paypal
    payment_id VARCHAR(100), -- 第三方支付ID
    paid_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (plan_id) REFERENCES plans(id)
);
```

### 3.6 推广相关表

#### referral_commissions (推广佣金表)
```sql
CREATE TABLE referral_commissions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_id INTEGER NOT NULL, -- 推荐人ID
    referee_id INTEGER NOT NULL, -- 被推荐人ID
    order_id INTEGER NOT NULL,
    commission_rate DECIMAL(5,2) NOT NULL, -- 佣金比例
    commission_amount DECIMAL(10,2) NOT NULL, -- 佣金金额
    status TINYINT DEFAULT 0, -- 0:待结算 1:已结算
    settled_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES users(id),
    FOREIGN KEY (referee_id) REFERENCES users(id),
    FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

## 4. API接口设计

### 4.1 用户认证接口
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `POST /api/auth/forgot-password` - 忘记密码
- `POST /api/auth/reset-password` - 重置密码

### 4.2 套餐接口
- `GET /api/plans` - 获取套餐列表
- `GET /api/plans/:id` - 获取套餐详情
- `POST /api/admin/plans` - 创建套餐
- `PUT /api/admin/plans/:id` - 更新套餐
- `DELETE /api/admin/plans/:id` - 删除套餐

### 4.3 订单接口
- `POST /api/orders` - 创建订单
- `GET /api/orders/:id` - 获取订单详情
- `POST /api/orders/:id/pay` - 支付订单
- `GET /api/user/orders` - 获取用户订单列表

### 4.4 兑换码接口
- `POST /api/redeem` - 兑换码兑换
- `POST /api/admin/redemption-codes/generate` - 批量生成兑换码
- `GET /api/admin/redemption-codes` - 获取兑换码列表

### 4.5 节点接口
- `GET /api/servers` - 获取节点列表
- `POST /api/admin/servers` - 添加节点
- `PUT /api/admin/servers/:id` - 更新节点
- `DELETE /api/admin/servers/:id` - 删除节点

### 4.6 用户管理接口
- `GET /api/user/profile` - 获取用户信息
- `PUT /api/user/profile` - 更新用户信息
- `GET /api/user/subscription` - 获取订阅信息
- `GET /api/user/referrals` - 获取推广信息

## 5. 页面结构设计

### 5.1 前台页面
```
/                    # 首页
/plans               # 套餐页面
/login               # 登录页面
/register            # 注册页面
/redeem              # 兑换码页面
/user/               # 用户中心
  ├── dashboard      # 仪表板
  ├── subscription   # 订阅管理
  ├── servers        # 节点信息
  ├── referral       # 推广中心
  ├── orders         # 订单记录
  └── profile        # 个人设置
```

### 5.2 后台页面
```
/admin/              # 管理后台
  ├── dashboard      # 仪表板
  ├── users          # 用户管理
  ├── plans          # 套餐管理
  ├── servers        # 节点管理
  ├── orders         # 订单管理
  ├── redemption     # 兑换码管理
  ├── referrals      # 推广管理
  ├── finance        # 财务管理
  └── settings       # 系统设置
```

## 6. 部署架构

### 6.1 Cloudflare Pages配置
```yaml
# wrangler.toml
name = "vpn-xpanel"
compatibility_date = "2024-01-01"

[env.production]
vars = { ENVIRONMENT = "production" }

[[env.production.d1_databases]]
binding = "DB"
database_name = "vpn-xpanel-db"
database_id = "your-d1-database-id"
```

### 6.2 环境变量配置
```env
# JWT密钥
JWT_SECRET=your-jwt-secret-key

# 支付配置
ALIPAY_APP_ID=your-alipay-app-id
ALIPAY_PRIVATE_KEY=your-alipay-private-key
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret

# 邮件服务
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-email-password
```

## 7. 安全考虑

### 7.1 数据安全
- [ ] 密码加密存储 (bcrypt)
- [ ] JWT Token认证
- [ ] API接口限流
- [ ] SQL注入防护
- [ ] XSS攻击防护

### 7.2 业务安全
- [ ] 订单重复提交防护
- [ ] 兑换码防刷机制
- [ ] 推广作弊检测
- [ ] 异常登录检测

## 8. 开发计划

### 8.1 第一阶段 (基础功能)
- [ ] 项目初始化和环境搭建
- [ ] 数据库设计和初始化
- [ ] 用户认证系统
- [ ] 套餐展示和购买流程
- [ ] 基础用户中心

### 8.2 第二阶段 (核心功能)
- [ ] 兑换码系统
- [ ] 节点管理系统
- [ ] 管理员后台基础功能
- [ ] 支付集成

### 8.3 第三阶段 (高级功能)
- [ ] 推广分销系统
- [ ] 财务管理系统
- [ ] 数据统计和报表
- [ ] 系统优化和性能调优

### 8.4 第四阶段 (完善功能)
- [ ] 移动端适配
- [ ] 多语言支持
- [ ] 高级安全功能
- [ ] 监控和日志系统

## 9. 技术要求

### 9.1 前端技术栈
- React 18+ with TypeScript
- Tailwind CSS for styling
- React Router for routing
- React Query for data fetching
- React Hook Form for forms
- Chart.js for data visualization

### 9.2 后端技术栈
- Cloudflare Workers
- Hono.js framework
- Cloudflare D1 database
- JWT for authentication
- Zod for validation

### 9.3 开发工具
- Vite for build tool
- ESLint + Prettier for code quality
- Wrangler for Cloudflare deployment
- GitHub Actions for CI/CD

## 10. 预期成果

完成后的系统将具备：
1. 完整的VPN销售功能
2. 多层级推广分销体系
3. 灵活的套餐和兑换码管理
4. 强大的管理后台
5. 良好的用户体验
6. 高性能和安全性
7. 易于维护和扩展

该系统将为VPN服务商提供一个完整的销售和管理解决方案，支持快速部署和运营。